/*
 * ═══════════════════════════════════════════════════════════════
 *                           COMBO KEYS
 * ═══════════════════════════════════════════════════════════════
 */

// ═══════════════════════════════════════════════════════════════
//                        キー位置定義（4行5列×2レイアウト）
// ═══════════════════════════════════════════════════════════════

// 上段（Row 0: 0-9）
#define POS_Q 0
#define POS_W 1
#define POS_E 2
#define POS_R 3
#define POS_T 4
#define POS_Y 5
#define POS_U 6
#define POS_I 7
#define POS_O 8
#define POS_P 9

// ホーム行（Row 1: 10-19）
#define POS_A 10
#define POS_S 11
#define POS_D 12
#define POS_F 13
#define POS_G 14
#define POS_H 15
#define POS_J 16
#define POS_K 17
#define POS_L 18
#define POS_MIN 19  // MINUS

// 下段（Row 2: 20-29）
#define POS_Z 20
#define POS_X 21
#define POS_C 22
#define POS_V 23
#define POS_B 24
#define POS_N 25
#define POS_M 26
#define POS_LCK 27  // LCLK
#define POS_RCK 28  // RCLK
#define POS_MO2 29  // mo 2

// 親指行（Row 3: 30-39）
#define POS_NONE1 30  // none
#define POS_NONE2 31  // none
#define POS_NONE3 32  // none
#define POS_LSH 33    // LSHIFT
#define POS_LCT 34    // LCTRL
#define POS_SPC 35    // SPACE
#define POS_ENT 36    // ENTER
#define POS_NONE4 37  // none
#define POS_NONE5 38  // none
#define POS_NONE6 39  // none

// ═══════════════════════════════════════════════════════════════
//                        マクロ関数（タイムアウト50固定）
// ═══════════════════════════════════════════════════════════════

// 基本Combo定義マクロ（全レイヤー有効）
#define CMB(name, pos1, pos2, binding) \
    combo_##name { \
        timeout-ms = <50>; \
        key-positions = <pos1 pos2>; \
        bindings = <binding>; \
    };

// レイヤー限定Combo定義マクロ
#define CMBL(name, pos1, pos2, binding, layer) \
    combo_##name { \
        timeout-ms = <70>; \
        key-positions = <pos1 pos2>; \
        bindings = <binding>; \
        layers = <layer>; \
    };

// 3キーCombo定義マクロ
#define CMB3(name, pos1, pos2, pos3, binding) \
    combo_##name { \
        timeout-ms = <70>; \
        key-positions = <pos1 pos2 pos3>; \
        bindings = <binding>; \
    };

// 4キーCombo定義マクロ
#define CMB4(name, pos1, pos2, pos3, pos4, binding) \
    combo_##name { \
        timeout-ms = <100>; \
        key-positions = <pos1 pos2 pos3 pos4>; \
        bindings = <binding>; \
    };

/ {
    combos {
        compatible = "zmk,combos";
        
        // 基本操作コンボ（全レイヤー共通）
        CMB(ime, POS_O, POS_P, &kp LC(SPACE))
        CMB(del, POS_L, POS_MIN, &kp DELETE)
        CMB(smk, POS_RCK, POS_MO2, &shift_mclk)
        CMB(cen, POS_LCK, POS_RCK, &mkp MCLK)
        CMB(esc, POS_Q, POS_W, &kp ESC)
        CMB(tab, POS_A, POS_S, &kp TAB)
        CMB(win, POS_Z, POS_X, &kp LWIN)
        
        // 親指行操作
        CMB(ccr, POS_LSH, POS_LCT, &kp LC(C))
        CMB(vcr, POS_LCT, POS_SPC, &kp LC(V))
        CMB(xcr, POS_LSH, POS_SPC, &kp LC(X))
        CMB(bsp, POS_SPC, POS_ENT, &kp BACKSPACE)

        // ファンクションキー
        CMB(f1, POS_Q, POS_A, &kp F1)
        CMB(f2, POS_W, POS_S, &kp F2)
        CMB(f3, POS_E, POS_D, &kp F3)
        CMB(f4, POS_R, POS_F, &kp F4)
        CMB(f5, POS_T, POS_G, &kp F5)
        CMB(f6, POS_Y, POS_H, &kp F6)
        CMB(f7, POS_U, POS_J, &kp F7)
        CMB(f8, POS_I, POS_K, &kp F8)
        CMB(f9, POS_O, POS_L, &kp F9)
        CMB(f10, POS_P, POS_MIN, &kp F10)
        CMB3(f11, POS_E, POS_R, POS_T, &kp F11)
        CMB3(f12, POS_Y, POS_U, POS_I, &kp F12)

        // 英語配列用記号キー（Layer 0-2）
        CMBL(qpo_en0, POS_R, POS_T, &kp SQT, 0)
        CMBL(qpo_en1, POS_R, POS_T, &kp SQT, 1)
        CMBL(qpo_en2, POS_R, POS_T, &kp SQT, 2)
        CMBL(dou_en0, POS_Y, POS_U, &kp DQT, 0)
        CMBL(dou_en1, POS_Y, POS_U, &kp DQT, 1)
        CMBL(dou_en2, POS_Y, POS_U, &kp DQT, 2)
        
        // 日本語配列用記号キー（Layer 3-5）
        CMBL(qpo_jp3, POS_R, POS_T, &kp JP_SQT, 3)
        CMBL(qpo_jp4, POS_R, POS_T, &kp JP_SQT, 4)
        CMBL(qpo_jp5, POS_R, POS_T, &kp JP_SQT, 5)
        CMBL(dou_jp3, POS_Y, POS_U, &kp JP_DQT, 3)
        CMBL(dou_jp4, POS_Y, POS_U, &kp JP_DQT, 4)
        CMBL(dou_jp5, POS_Y, POS_U, &kp JP_DQT, 5)
        
        CMBL(sem_jp3, POS_F, POS_G, &kp JP_SEMICOLON, 3)
        CMBL(sem_jp4, POS_F, POS_G, &kp JP_SEMICOLON, 4)
        CMBL(sem_jp5, POS_F, POS_G, &kp JP_SEMICOLON, 5)
        CMBL(col_jp3, POS_H, POS_J, &kp JP_COLON, 3)
        CMBL(col_jp4, POS_H, POS_J, &kp JP_COLON, 4)
        CMBL(col_jp5, POS_H, POS_J, &kp JP_COLON, 5)
        
        CMBL(lbr_jp3, POS_E, POS_R, &kp JP_LBKT, 3)
        CMBL(lbr_jp4, POS_E, POS_R, &kp JP_LBKT, 4)
        CMBL(lbr_jp5, POS_E, POS_R, &kp JP_LBKT, 5)
        CMBL(rbr_jp3, POS_U, POS_I, &kp JP_RBKT, 3)
        CMBL(rbr_jp4, POS_U, POS_I, &kp JP_RBKT, 4)
        CMBL(rbr_jp5, POS_U, POS_I, &kp JP_RBKT, 5)
        
        CMBL(lbs_jp3, POS_D, POS_F, &kp JP_LBRC, 3)
        CMBL(lbs_jp4, POS_D, POS_F, &kp JP_LBRC, 4)
        CMBL(lbs_jp5, POS_D, POS_F, &kp JP_LBRC, 5)
        CMBL(rbs_jp3, POS_J, POS_K, &kp JP_RBRC, 3)
        CMBL(rbs_jp4, POS_J, POS_K, &kp JP_RBRC, 4)
        CMBL(rbs_jp5, POS_J, POS_K, &kp JP_RBRC, 5)
        
        CMBL(bac_jp3, POS_G, POS_B, &kp JP_YEN, 3)
        CMBL(bac_jp4, POS_G, POS_B, &kp JP_YEN, 4)
        CMBL(bac_jp5, POS_G, POS_B, &kp JP_YEN, 5)

        // 矢印キー（レイヤー別）
        CMBL(up0, POS_W, POS_E, &kp UP, 0)
        CMBL(dn0, POS_S, POS_D, &kp DOWN, 0)
        CMBL(lt0, POS_A, POS_D, &kp LEFT, 0)
        CMBL(rt0, POS_D, POS_F, &kp RIGHT, 0)
        CMBL(up3, POS_W, POS_E, &kp UP, 3)
        CMBL(dn3, POS_S, POS_D, &kp DOWN, 3)
        CMBL(lt3, POS_A, POS_D, &kp LEFT, 3)
        CMBL(rt3, POS_D, POS_F, &kp RIGHT, 3)

        // レイヤー切り替え
        CMB4(layer3, POS_R, POS_T, POS_Y, POS_U, &tog 3)
    };
};
